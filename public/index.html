<!DOCTYPE html>
<html lang=en>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
<style>
  @keyframes slideUpFade{
from{
transform: translateY(20px);
opacity: 0;
}
to{
transform: translateY(0);
opacity: 1;
}
  }
body {
background-color: #ff9999;
display: flex;
align-items: center;
flex-direction: column;
}
#camera {
border: none;
border-radius: 10px;
box-shadow: 0 0 10px rgba(0,0,0,0.5);
display: block;
width: 300px;
height: 400px;
object-fit: cover;
padding: 5px;
  animation: slideUpFade 0.5s ease-out;
}
#previewcanvas {
padding: 5px;
border: none;
border-radius: 10px;
}
#btn2{
background-color: FloralWhite;
  border-radius: 10px;
  border: none;
  padding: 10px;
  animation: slideUpFade 0.5s ease-out;
}
#btn2:hover{
background-color: red;
transform: scale(1.03);
transition: all 0.2s ease-in-out;
}
#overlay,#newoverlay{
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  visibility: hidden;
     display: flex;
     flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 1001;
    backdrop-filter: blur(8px);
    background-color: rgba(0,0,0,0.5);
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  #newoverlay div {
    background-color: white;
    padding: 20px 30px;
    border-radius: 10px;
    font-size: 1.5em;
    text-align: center;
    color: black;
    box-shadow: 0 0 15px rgba(0,0,0,0.5);
}
  #overlay.show,#newoverlay.show{
    visibility: visible;
    opacity: 1;
  }
  #previewcanvas{
    max-height: 90vh;
    max-width: 90vw;
    height: auto;
    width: auto;
    z-index: 1002;
    border-radius: 10px;
    border: none;
  }
</style>
    <title>Camera Access</title>
</head>
<body>
  <div id="main" style="display:none;">
  <div id="newoverlay">
  <div id="message">
  <p id="p">Capturing image...</p>
  </div>
  </div>
    <div id="overlay">
      <canvas id="previewcanvas"></canvas>
      <button id="btn2" style="display:none;">next</button>
    </div>
    <div style="position:relative; width:300px; height:400px;">
    <video id="camera" width="300" height="400" autoplay></video>
    <canvas id="overlaycanvas" style="position:absolute;top:0;left:0;width:300px;height:400px;"></canvas>
    </div>
    </div>
  </div>
    <script>
        const video = document.getElementById('camera');
        const previewcanvas = document.getElementById('previewcanvas');
        const copiedContext = previewcanvas.getContext('2d');
        const main = document.getElementById('main');
        const savebtn = document.getElementById('btn2');
        const overlaycanvas = document.getElementById("overlaycanvas");
        const overlayContext = overlaycanvas.getContext('2d')
      const overlay = document.getElementById("overlay");
      const newoverlay = document.getElementById('newoverlay');
      let model;
      let interval1 = null;
      async function loadModel(){
          model = await faceapi.nets.tinyFaceDetector.loadFromUri(./models/);
          console.log("face detection model loaded");
      }
      let detectionPaused = false;
function showCapturedFace(start, area) {

    newoverlay.classList.add('show');
    void newoverlay.offsetWidth;

    setTimeout(() => {
        newoverlay.classList.remove('show');
        overlay.classList.add('show');
        copiedContext.clearRect(0, 0, previewcanvas.width, previewcanvas.height);
        copiedContext.filter = 'grayscale(100%) contrast(200%)';
        copiedContext.drawImage(
            video,
            start[0], start[1], area[0], area[1],
            0, 0, previewcanvas.width, previewcanvas.height
        );
        savebtn.style.display = "block";
    }, 3000);
}

let interval = null;
      // Request camera access
        navigator.mediaDevices.getUserMedia({ video: true })
            .then( async (stream) => {
              await loadModel();
                video.srcObject = stream;
                main.style.display = "block";
                video.addEventListener("loadeddata", () => {
                overlaycanvas.width = video.videoWidth;
                overlaycanvas.height = video.videoHeight;
             interval =  setInterval(async () =>{
                overlayContext.clearRect(0, 0, overlaycanvas.width, overlaycanvas.height);
               const livePredictions = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions());
                if(livePredictions.length > 0){
                livePredictions.forEach(pred => {
                /*const start = pred.topLeft;
                const end = pred.bottomRight;
                const area = [end[0] - start[0], end[1] - start[1]];*/
                  const box = pred.box;
                overlayContext.strokeStyle = "red";
                overlayContext.lineWidth = 3;
                //overlayContext.strokeRect(start[0], start[1], area[0], area[1]);
                  overlayContext.strokeRect(box.x, box.y, box.width, box.height);
                if(!detectionPaused){
                detectionPaused = true;
                //showCapturedFace(start,area);
                  showCapturedFace({x: box.x, y: box.y},{width: box.width, height: box.height})
                }
                });
                }
                },100);
                });
            })
            .catch(err => {
                console.error('Error accessing camera:', err);
                alert('Please allow camera access!');
            });
        savebtn.addEventListener("click",() => {
        const dataURL = previewcanvas.toDataURL();
sessionStorage.setItem('imageData',dataURL);
window.location.href = 'chatgpt.html';
        });
    </script>
</body>
</html>
